import "c";
import "std";

import "shared.sunder";

struct server_state {
    var board: board;

    func init() server_state {
        var board = board::init_starter_map_for_beginners();

        return (:server_state){
            .board = board,
        };
    }

    func fini(self: *server_state) void {
        self.*.board.fini();
    }

    func place_road(self: *server_state, road: road) void {
        insert_road(&self.*.board.roads, road);
    }

    func remove_road(self: *server_state, edge: edge) void {
        self.*.board.roads.remove(edge);
    }

    func place_town(self: *server_state, town: town) void {
        insert_town(&self.*.board.towns, town);
    }

    func remove_town(self: *server_state, node: node) void {
        self.*.board.towns.remove(node);
    }

    func update_from_client_message(self: *server_state, message: *client_message, sender: *message_sender[[server_message]]) void {
        switch message.*.kind {
        client_message::BUILD_ROAD {
            self.*.place_road(message.*.data.build_road);
            var message = server_message::init_accepted("built road");
            defer message.fini();
            sender.*.send(&message);
        }
        client_message::BUILD_TOWN {
            self.*.place_town(message.*.data.build_town);
            var message = server_message::init_accepted("built town");
            defer message.fini();
            sender.*.send(&message);
        }
        client_message::REMOVE_ROAD {
            self.*.remove_road(message.*.data.remove_road);
            var message = server_message::init_accepted("removed road");
            defer message.fini();
            sender.*.send(&message);
        }
        client_message::REMOVE_TOWN {
            self.*.remove_town(message.*.data.remove_town);
            var message = server_message::init_accepted("removed town");
            defer message.fini();
            sender.*.send(&message);
        }
        }
    }
}

func server_update(sstate: *server_state, sender: *message_sender[[server_message]]) void {
    var message = server_message::init_board(&sstate.*.board);
    sender.*.send(&message);
    message.fini();
}
